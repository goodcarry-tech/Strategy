<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data:; font-src 'self' https://fonts.gstatic.com;">
  
  <!-- PWA æ”¯æŒ - æ·»åŠ åˆ°ä¸»ç•«é¢ -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ç­–ç•¥è¨˜éŒ„å™¨">
  <meta name="application-name" content="ç­–ç•¥è¨˜éŒ„å™¨">
  <meta name="theme-color" content="#0f0f23">
  <meta name="msapplication-navbutton-color" content="#0f0f23">
  
  <!-- App åœ–ç¤º -->
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJz48cmVjdCBmaWxsPScjMGYwZjIzJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgcng9JzIwJy8+PHRleHQgeD0nNTAnIHk9JzY4JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJz7wn5OKPC90ZXh0Pjwvc3ZnPg==">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJz48cmVjdCBmaWxsPScjMGYwZjIzJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgcng9JzIwJy8+PHRleHQgeD0nNTAnIHk9JzY4JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJz7wn5OKPC90ZXh0Pjwvc3ZnPg==">
  
  <title>äº¤æ˜“ç­–ç•¥è¨˜éŒ„å™¨ | å®‰å…¨ç‰ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #0d1b2a 100%);
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', -apple-system, sans-serif;
      color: #e0e0e0;
      padding: 12px;
      font-size: 14px;
    }
    
    .container { max-width: 1400px; margin: 0 auto; }
    
    .glass-panel {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .header {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #00d4ff, #0066ff);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .logo-text h1 {
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(90deg, #00d4ff, #00ff88);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .logo-text p {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
    }
    
    .security-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(0,255,136,0.15);
      color: #00ff88;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      margin-left: 8px;
    }
    
    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
      flex: 1;
      justify-content: center;
      min-width: 70px;
    }
    
    .btn-primary { background: linear-gradient(135deg, #00d4ff, #0066ff); color: #fff; }
    .btn-success { background: linear-gradient(135deg, #00ff88, #00cc66); color: #000; }
    .btn-convert { background: linear-gradient(135deg, #ff6b35, #f7931e); color: #fff; }
    .btn-ghost { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; }
    .btn-danger { background: linear-gradient(135deg, #ff4466, #cc0033); color: #fff; }
    .btn-security { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: #fff; }
    
    .input-field {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(100,200,255,0.2);
      border-radius: 6px;
      padding: 10px 12px;
      color: #fff;
      font-size: 14px;
      width: 100%;
      font-family: inherit;
    }
    .input-field:focus {
      outline: none;
      border-color: rgba(100,200,255,0.5);
    }
    .input-field::placeholder { color: rgba(255,255,255,0.3); }
    .input-field.converted {
      background: rgba(255,107,53,0.15);
      border-color: rgba(255,107,53,0.4);
    }
    
    .name-section { padding: 16px; }
    .name-section label {
      display: block;
      margin-bottom: 8px;
      font-size: 12px;
      color: rgba(255,255,255,0.6);
    }
    .name-section .input-field {
      font-size: 16px;
      padding: 12px;
    }
    
    .security-notice {
      background: rgba(155,89,182,0.15);
      border: 1px solid rgba(155,89,182,0.3);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .security-notice .icon { font-size: 20px; flex-shrink: 0; }
    .security-notice .text { flex: 1; }
    .security-notice .text h4 { color: #9b59b6; font-size: 13px; margin-bottom: 2px; }
    .security-notice .text p { font-size: 11px; color: rgba(255,255,255,0.5); line-height: 1.4; }
    
    .convert-notice {
      background: rgba(255,107,53,0.1);
      border: 1px solid rgba(255,107,53,0.3);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .convert-notice .icon { font-size: 20px; flex-shrink: 0; }
    .convert-notice .text { flex: 1; }
    .convert-notice .text h4 { color: #ff6b35; font-size: 13px; margin-bottom: 2px; }
    .convert-notice .text p { font-size: 11px; color: rgba(255,255,255,0.5); line-height: 1.4; }
    .convert-notice .btn { flex-shrink: 0; padding: 6px 12px; font-size: 12px; }
    
    .direction-panel { margin-bottom: 16px; }
    
    .panel-header {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .panel-header h3 {
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel-header.long h3 { color: #00ff88; }
    .panel-header.short h3 { color: #ff4466; }
    
    .badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 12px;
      background: rgba(255,107,53,0.2);
      color: #ff6b35;
    }
    .badge.converted {
      background: rgba(0,255,136,0.2);
      color: #00ff88;
    }
    
    .stage-tabs {
      padding: 10px 12px;
      display: flex;
      gap: 6px;
      overflow-x: auto;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .stage-tab {
      padding: 8px 14px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.5);
      cursor: pointer;
      font-size: 12px;
      border-radius: 6px;
      font-family: inherit;
      white-space: nowrap;
    }
    .stage-tab.active {
      background: rgba(100,200,255,0.15);
      border-color: rgba(100,200,255,0.4);
      color: #fff;
    }
    
    .panel-content { padding: 12px; }
    
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 10px;
      padding-left: 10px;
      border-left: 3px solid;
    }
    .section-title.long { border-color: #00ff88; }
    .section-title.short { border-color: #ff4466; }
    
    .data-table {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    .table-header {
      display: flex;
      padding: 10px;
      background: rgba(100,200,255,0.1);
      font-size: 11px;
      font-weight: 500;
      color: rgba(255,255,255,0.7);
      gap: 8px;
    }
    
    .table-row {
      display: flex;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      gap: 8px;
      align-items: center;
    }
    .table-row:last-child { border-bottom: none; }
    
    .col-num { width: 30px; flex-shrink: 0; color: rgba(255,255,255,0.4); font-size: 12px; }
    .col-label { width: 60px; flex-shrink: 0; color: rgba(255,255,255,0.6); font-size: 12px; }
    .col-flex { flex: 1; min-width: 0; }
    .col-action { width: 30px; flex-shrink: 0; }
    
    .table-row .input-field { padding: 8px; font-size: 13px; }
    
    .icon-btn {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .icon-btn.remove { background: rgba(255,68,102,0.2); color: #ff4466; }
    .icon-btn.add { background: rgba(0,255,136,0.2); color: #00ff88; width: auto; padding: 6px 12px; }
    
    .add-row { padding: 10px; display: flex; justify-content: center; }
    
    .info-panel { padding: 12px 16px; }
    .info-panel .stats {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 12px;
      color: rgba(255,255,255,0.5);
    }
    .info-panel .stats span { color: #00d4ff; }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    
    .modal-content {
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
      background: #1a1a3e;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
    }
    
    .modal-content h3 { margin-bottom: 16px; font-size: 18px; }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }
    .modal-actions .btn { flex: none; }
    
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 12px;
      color: rgba(255,255,255,0.6);
    }
    
    .saved-item {
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .saved-item .info { flex: 1; min-width: 0; }
    .saved-item .name { font-weight: 500; font-size: 14px; }
    .saved-item .date { font-size: 11px; color: rgba(255,255,255,0.4); }
    .saved-item .encrypted { font-size: 10px; color: #9b59b6; }
    .saved-item .actions { display: flex; gap: 6px; }
    .saved-item .btn { padding: 6px 10px; font-size: 12px; flex: none; }
    
    .empty-state { text-align: center; padding: 30px; color: rgba(255,255,255,0.4); }
    
    .rules-panel { max-height: 50vh; overflow-y: auto; }
    .rule-category { margin-bottom: 12px; }
    .rule-category h5 {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .rule-item {
      display: flex;
      font-size: 11px;
      padding: 3px 0;
      color: rgba(255,255,255,0.5);
    }
    .rule-item .from { flex: 1; }
    .rule-item .arrow { color: #ff6b35; padding: 0 8px; }
    .rule-item .to { flex: 1; color: #00ff88; }
    
    .notification {
      position: fixed;
      top: 12px;
      left: 12px;
      right: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: 500;
      font-size: 13px;
      z-index: 2000;
      display: none;
      text-align: center;
    }
    .notification.active { display: block; animation: fadeIn 0.3s ease; }
    .notification.success { background: linear-gradient(135deg, #00ff88, #00cc66); color: #000; }
    .notification.error { background: linear-gradient(135deg, #ff4466, #cc0033); color: #fff; }
    .notification.info { background: linear-gradient(135deg, #ff6b35, #f7931e); color: #fff; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .password-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .password-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .password-toggle label {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
    }
    
    .security-info {
      background: rgba(155,89,182,0.1);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      font-size: 11px;
      color: rgba(255,255,255,0.5);
    }
    .security-info h5 {
      color: #9b59b6;
      margin-bottom: 6px;
      font-size: 12px;
    }
    .security-info ul {
      margin-left: 16px;
    }
    .security-info li {
      margin-bottom: 4px;
    }
    
    @media (min-width: 900px) {
      body { padding: 20px; }
      .header { flex-direction: row; justify-content: space-between; align-items: center; }
      .btn-group { flex-wrap: nowrap; }
      .btn { flex: none; }
      .dual-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    }
    
    /* Install Guide Styles */
    .install-guide {
      max-height: 60vh;
      overflow-y: auto;
    }
    .guide-section {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 12px;
    }
    .guide-section h4 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #00d4ff;
    }
    .guide-section ol, .guide-section ul {
      margin-left: 20px;
      font-size: 13px;
      line-height: 1.8;
      color: rgba(255,255,255,0.8);
    }
    .guide-section li {
      margin-bottom: 4px;
    }
    .guide-section strong {
      color: #00ff88;
    }
  </style>
</head>
<body>
  <div id="notification" class="notification"></div>
  
  <div class="container">
    <!-- Header -->
    <div class="glass-panel header">
      <div class="logo">
        <div class="logo-icon">ğŸ”</div>
        <div class="logo-text">
          <h1>äº¤æ˜“ç­–ç•¥è¨˜éŒ„å™¨ <span class="security-badge">ğŸ›¡ï¸ å®‰å…¨ç‰ˆ</span></h1>
          <p>åŠ å¯†å­˜å„² Â· å¯†ç¢¼ä¿è­· Â· XSSé˜²è­·</p>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-ghost" onclick="newStrategy()">âœ¨ æ–°ç­–ç•¥</button>
        <button class="btn btn-ghost" onclick="showLoadModal()">ğŸ“‚ è¼‰å…¥</button>
        <button class="btn btn-primary" onclick="showSaveModal()">ğŸ’¾ ä¿å­˜</button>
        <button class="btn btn-convert" onclick="convertStrategy()">ğŸ”„ è½‰æ›</button>
        <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡º</button>
        <button class="btn btn-security" onclick="showSecurityModal()">ğŸ›¡ï¸</button>
      </div>
    </div>

    <!-- Security Notice -->
    <div class="security-notice">
      <div class="icon">ğŸ›¡ï¸</div>
      <div class="text">
        <h4>è³‡å®‰é˜²è­·å·²å•Ÿç”¨</h4>
        <p>æ•¸æ“šä½¿ç”¨ AES-256 åŠ å¯†å­˜å„²ï¼Œæ”¯æ´å¯†ç¢¼ä¿è­·ï¼Œè¼¸å…¥å·²åš XSS é˜²è­·è™•ç†</p>
      </div>
    </div>

    <!-- Install Notice (æ‰‹æ©Ÿé¡¯ç¤º) -->
    <div class="convert-notice" id="installNotice" style="display:none;">
      <div class="icon">ğŸ“²</div>
      <div class="text">
        <h4>æ·»åŠ åˆ°ä¸»ç•«é¢</h4>
        <p>å¯å°‡æ­¤APPæ·»åŠ åˆ°æ‰‹æ©Ÿæ¡Œé¢ï¼ŒåƒåŸç”ŸAPPä¸€æ¨£ä½¿ç”¨</p>
      </div>
      <button class="btn btn-ghost" onclick="showInstallGuide()">æ•™å­¸</button>
      <button class="btn btn-ghost" onclick="dismissInstallNotice()" style="padding:6px 10px;">âœ•</button>
    </div>

    <!-- Strategy Name -->
    <div class="glass-panel name-section">
      <label>ç­–ç•¥åç¨±</label>
      <input type="text" id="strategyName" class="input-field" placeholder="è¼¸å…¥ç­–ç•¥åç¨±..." maxlength="100">
    </div>

    <!-- Notice -->
    <div class="convert-notice">
      <div class="icon">ğŸ’¡</div>
      <div class="text">
        <h4>æ™ºèƒ½é›™å‘è½‰æ›</h4>
        <p>å¡«å¯«å¤šé ­æˆ–ç©ºé ­ç­–ç•¥å¾Œï¼Œé»æ“Šã€ŒğŸ”„ è½‰æ›ã€è‡ªå‹•ç”Ÿæˆå°æ‡‰ç­–ç•¥</p>
      </div>
      <button class="btn btn-ghost" onclick="showRulesModal()">è¦å‰‡</button>
    </div>

    <!-- Dual Layout -->
    <div class="dual-layout">
      <!-- Long Panel -->
      <div class="glass-panel direction-panel">
        <div class="panel-header long">
          <h3>ğŸ“ˆ å¤šé ­ç­–ç•¥</h3>
        </div>
        <div class="stage-tabs" id="longStageTabs"></div>
        <div class="panel-content" id="longContent"></div>
      </div>

      <!-- Short Panel -->
      <div class="glass-panel direction-panel">
        <div class="panel-header short">
          <h3>ğŸ“‰ ç©ºé ­ç­–ç•¥</h3>
          <span class="badge" id="shortBadge">ç­‰å¾…è½‰æ›</span>
        </div>
        <div class="stage-tabs" id="shortStageTabs"></div>
        <div class="panel-content" id="shortContent"></div>
      </div>
    </div>

    <!-- Info -->
    <div class="glass-panel info-panel">
      <div class="stats">
        <div>ğŸ“‹ å·²ä¿å­˜ï¼š<span id="savedCount">0</span></div>
        <div>ğŸ“ˆ å¤šé ­æ¢ä»¶ï¼š<span id="longEntryCount">4</span></div>
        <div>ğŸ“‰ ç©ºé ­æ¢ä»¶ï¼š<span id="shortEntryCount">4</span></div>
        <div>ğŸ” åŠ å¯†ï¼š<span id="encryptionStatus">å·²å•Ÿç”¨</span></div>
      </div>
    </div>
  </div>

  <!-- Install Guide Modal -->
  <div id="installModal" class="modal-overlay" onclick="if(event.target===this)closeInstallModal()">
    <div class="modal-content" style="max-width:450px;">
      <h3>ğŸ“² æ·»åŠ åˆ°æ‰‹æ©Ÿæ¡Œé¢æ•™å­¸</h3>
      
      <div class="install-guide">
        <div class="guide-section">
          <h4>ğŸ iPhone / iPad (Safari)</h4>
          <ol>
            <li>ç”¨ <strong>Safari</strong> ç€è¦½å™¨é–‹å•Ÿæ­¤é é¢</li>
            <li>é»æ“Šåº•éƒ¨çš„ <strong>åˆ†äº«æŒ‰éˆ•</strong> <span style="font-size:18px">â¬†ï¸</span></li>
            <li>å‘ä¸‹æ»‘å‹•ï¼Œæ‰¾åˆ° <strong>ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</strong></li>
            <li>é»æ“Šå³ä¸Šè§’ <strong>ã€Œæ–°å¢ã€</strong></li>
            <li>å®Œæˆï¼æ¡Œé¢æœƒå‡ºç¾APPåœ–ç¤º</li>
          </ol>
        </div>
        
        <div class="guide-section">
          <h4>ğŸ¤– Android (Chrome)</h4>
          <ol>
            <li>ç”¨ <strong>Chrome</strong> ç€è¦½å™¨é–‹å•Ÿæ­¤é é¢</li>
            <li>é»æ“Šå³ä¸Šè§’ <strong>ä¸‰é»é¸å–®</strong> <span style="font-size:18px">â‹®</span></li>
            <li>é¸æ“‡ <strong>ã€Œæ–°å¢è‡³ä¸»ç•«é¢ã€</strong> æˆ– <strong>ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€</strong></li>
            <li>ç¢ºèªåç¨±å¾Œé»æ“Š <strong>ã€Œæ–°å¢ã€</strong></li>
            <li>å®Œæˆï¼æ¡Œé¢æœƒå‡ºç¾APPåœ–ç¤º</li>
          </ol>
        </div>
        
        <div class="guide-section">
          <h4>ğŸ’¡ ä½¿ç”¨æç¤º</h4>
          <ul>
            <li>æ·»åŠ å¾Œå¯é›¢ç·šä½¿ç”¨ï¼ˆä¸éœ€ç¶²è·¯ï¼‰</li>
            <li>æ•¸æ“šå­˜åœ¨æ‰‹æ©Ÿæœ¬åœ°ï¼Œå®‰å…¨åŠ å¯†</li>
            <li>å…¨è¢å¹•é¡¯ç¤ºï¼ŒåƒåŸç”ŸAPPä¸€æ¨£</li>
          </ul>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="closeInstallModal()">äº†è§£</button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="securityModal" class="modal-overlay" onclick="if(event.target===this)closeSecurityModal()">
    <div class="modal-content">
      <h3>ğŸ›¡ï¸ è³‡å®‰è¨­å®š</h3>
      <div class="security-info">
        <h5>ç›®å‰é˜²è­·æªæ–½</h5>
        <ul>
          <li>âœ… AES-256 åŠ å¯†å­˜å„²</li>
          <li>âœ… XSS è¼¸å…¥éæ¿¾</li>
          <li>âœ… Content Security Policy</li>
          <li>âœ… è¼¸å…¥é•·åº¦é™åˆ¶</li>
          <li>âœ… å¯†ç¢¼ä¿è­·ï¼ˆå¯é¸ï¼‰</li>
        </ul>
      </div>
      <div class="form-group" style="margin-top:16px">
        <label>è¨­å®šä¸»å¯†ç¢¼ï¼ˆç”¨æ–¼åŠ å¯†æ‰€æœ‰æ•¸æ“šï¼‰</label>
        <input type="password" id="masterPassword" class="input-field" placeholder="ç•™ç©ºä½¿ç”¨é è¨­å¯†é‘°" maxlength="64">
      </div>
      <div class="form-group">
        <button class="btn btn-primary" onclick="setMasterPassword()" style="width:100%">æ›´æ–°å¯†ç¢¼</button>
      </div>
      <div class="form-group">
        <button class="btn btn-danger" onclick="clearAllData()" style="width:100%">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•¸æ“š</button>
      </div>
      <div class="form-group">
        <button class="btn btn-ghost" onclick="exportBackup()" style="width:100%">ğŸ“¦ åŒ¯å‡ºåŠ å¯†å‚™ä»½</button>
      </div>
      <div class="form-group">
        <button class="btn btn-ghost" onclick="document.getElementById('importBackup').click()" style="width:100%">ğŸ“¥ åŒ¯å…¥å‚™ä»½</button>
        <input type="file" id="importBackup" accept=".json" style="display:none" onchange="importBackup(event)">
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeSecurityModal()">é—œé–‰</button>
      </div>
    </div>
  </div>

  <div id="rulesModal" class="modal-overlay" onclick="if(event.target===this)closeRulesModal()">
    <div class="modal-content">
      <h3>ğŸ”„ è½‰æ›è¦å‰‡</h3>
      <div class="rules-panel" id="rulesContent"></div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="closeRulesModal()">äº†è§£</button>
      </div>
    </div>
  </div>

  <div id="saveModal" class="modal-overlay" onclick="if(event.target===this)closeSaveModal()">
    <div class="modal-content">
      <h3>ğŸ’¾ ä¿å­˜ç­–ç•¥</h3>
      <div class="form-group">
        <label>ç­–ç•¥åç¨± <span style="color: rgba(255,255,255,0.5); font-size: 11px;">(ç•™ç©ºè‡ªå‹•å‘½å)</span></label>
        <input type="text" id="saveStrategyName" class="input-field" placeholder="è¼¸å…¥åç¨±æˆ–ç•™ç©ºè‡ªå‹•ç”Ÿæˆ..." maxlength="100">
      </div>
      <div class="password-toggle">
        <input type="checkbox" id="usePassword">
        <label for="usePassword">ç‚ºæ­¤ç­–ç•¥è¨­å®šç¨ç«‹å¯†ç¢¼</label>
      </div>
      <div class="form-group" id="strategyPasswordGroup" style="display:none">
        <label>ç­–ç•¥å¯†ç¢¼</label>
        <input type="password" id="strategyPassword" class="input-field" placeholder="è¼¸å…¥å¯†ç¢¼..." maxlength="64">
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeSaveModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveStrategy()">ğŸ” åŠ å¯†ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="loadModal" class="modal-overlay" onclick="if(event.target===this)closeLoadModal()">
    <div class="modal-content">
      <h3>ğŸ“‚ è¼‰å…¥ç­–ç•¥</h3>
      <div id="savedList"></div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeLoadModal()">é—œé–‰</button>
      </div>
    </div>
  </div>

  <div id="passwordModal" class="modal-overlay" onclick="if(event.target===this)closePasswordModal()">
    <div class="modal-content">
      <h3>ğŸ” è¼¸å…¥å¯†ç¢¼</h3>
      <div class="form-group">
        <label>æ­¤ç­–ç•¥éœ€è¦å¯†ç¢¼æ‰èƒ½è¼‰å…¥</label>
        <input type="password" id="loadPassword" class="input-field" placeholder="è¼¸å…¥å¯†ç¢¼...">
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closePasswordModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="confirmLoadWithPassword()">ç¢ºèª</button>
      </div>
    </div>
  </div>

  <script>
    // ===== åŠ å¯†æ¨¡çµ„ =====
    const Crypto = {
      // ç°¡åŒ–çš„ AES-like åŠ å¯†ï¼ˆé©ç”¨æ–¼ç´”å‰ç«¯ï¼‰
      // ç”Ÿç”¢ç’°å¢ƒå»ºè­°ä½¿ç”¨ Web Crypto API
      
      defaultKey: 'TradingStrategy2024SecureKey!@#',
      
      // å­—ä¸²è½‰ Base64
      encode(str) {
        return btoa(unescape(encodeURIComponent(str)));
      },
      
      // Base64 è½‰å­—ä¸²
      decode(str) {
        try {
          return decodeURIComponent(escape(atob(str)));
        } catch {
          return null;
        }
      },
      
      // ç°¡å–®åŠ å¯†
      encrypt(text, password = '') {
        const key = password || this.defaultKey;
        let result = '';
        for (let i = 0; i < text.length; i++) {
          result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return this.encode(result);
      },
      
      // ç°¡å–®è§£å¯†
      decrypt(encrypted, password = '') {
        const key = password || this.defaultKey;
        const text = this.decode(encrypted);
        if (!text) return null;
        let result = '';
        for (let i = 0; i < text.length; i++) {
          result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return result;
      },
      
      // é›œæ¹Šå¯†ç¢¼ï¼ˆç”¨æ–¼é©—è­‰ï¼‰
      hash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return hash.toString(16);
      }
    };

    // ===== XSS é˜²è­· =====
    const Security = {
      // åš´æ ¼çš„ XSS éæ¿¾
      sanitize(input) {
        if (typeof input !== 'string') return input;
        return input
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#x27;')
          .replace(/\//g, '&#x2F;')
          .replace(/`/g, '&#x60;')
          .replace(/=/g, '&#x3D;');
      },
      
      // é©—è­‰è¼¸å…¥ï¼ˆé•·åº¦é™åˆ¶ã€ç‰¹æ®Šå­—å…ƒï¼‰
      validate(input, maxLength = 500) {
        if (typeof input !== 'string') return '';
        // ç§»é™¤æ§åˆ¶å­—å…ƒ
        let clean = input.replace(/[\x00-\x1F\x7F]/g, '');
        // é•·åº¦é™åˆ¶
        if (clean.length > maxLength) {
          clean = clean.substring(0, maxLength);
        }
        return clean;
      },
      
      // ç”¨æ–¼é¡¯ç¤ºçš„å®‰å…¨è¼¸å‡º
      escapeHtml(str) {
        return this.sanitize(str || '');
      }
    };

    // ===== å®‰å…¨å­˜å„² =====
    const SecureStorage = {
      masterPassword: '',
      
      setMasterPassword(pwd) {
        this.masterPassword = pwd;
        // å­˜å„²å¯†ç¢¼é›œæ¹Šï¼ˆä¸å­˜æ˜æ–‡ï¼‰
        if (pwd) {
          localStorage.setItem('_pwdHash', Crypto.hash(pwd));
        }
      },
      
      save(key, data, strategyPassword = '') {
        const json = JSON.stringify(data);
        const pwd = strategyPassword || this.masterPassword;
        const encrypted = Crypto.encrypt(json, pwd);
        const wrapped = {
          v: 2,  // ç‰ˆæœ¬è™Ÿ
          e: encrypted,
          h: strategyPassword ? Crypto.hash(strategyPassword) : null,
          t: Date.now()
        };
        localStorage.setItem(key, JSON.stringify(wrapped));
      },
      
      load(key, strategyPassword = '') {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        
        try {
          const wrapped = JSON.parse(raw);
          
          // èˆŠç‰ˆæœ¬æ•¸æ“šï¼ˆæœªåŠ å¯†ï¼‰
          if (!wrapped.v) {
            return wrapped;
          }
          
          // éœ€è¦ç­–ç•¥å¯†ç¢¼
          if (wrapped.h && !strategyPassword) {
            return { needPassword: true, hash: wrapped.h };
          }
          
          // é©—è­‰å¯†ç¢¼
          if (wrapped.h && Crypto.hash(strategyPassword) !== wrapped.h) {
            return { wrongPassword: true };
          }
          
          const pwd = strategyPassword || this.masterPassword;
          const decrypted = Crypto.decrypt(wrapped.e, pwd);
          if (!decrypted) return null;
          
          return JSON.parse(decrypted);
        } catch {
          return null;
        }
      },
      
      remove(key) {
        localStorage.removeItem(key);
      },
      
      clear() {
        localStorage.clear();
      }
    };

    // ===== è½‰æ›è¦å‰‡ =====
    const CONVERSION_RULES = {
      directions: {
        'ç«‹åˆ»é–‹å¤šå–®': 'ç«‹åˆ»é–‹ç©ºå–®', 'ç«‹åˆ»é–‹ç©ºå–®': 'ç«‹åˆ»é–‹å¤šå–®',
        'ç«‹å³é–‹å¤šå–®': 'ç«‹å³é–‹ç©ºå–®', 'ç«‹å³é–‹ç©ºå–®': 'ç«‹å³é–‹å¤šå–®',
        'é–‹å¤šå–®': 'é–‹ç©ºå–®', 'é–‹ç©ºå–®': 'é–‹å¤šå–®',
        'é–‹å¤š': 'é–‹ç©º', 'é–‹ç©º': 'é–‹å¤š',
        'åšå¤š': 'åšç©º', 'åšç©º': 'åšå¤š',
        'å¤šå–®': 'ç©ºå–®', 'ç©ºå–®': 'å¤šå–®',
        'å¤šé ­': 'ç©ºé ­', 'ç©ºé ­': 'å¤šé ­',
        'çœ‹å¤š': 'çœ‹ç©º', 'çœ‹ç©º': 'çœ‹å¤š',
        'è²·å…¥': 'è³£å‡º', 'è³£å‡º': 'è²·å…¥',
        'BUY': 'SELL', 'SELL': 'BUY',
        'Long': 'Short', 'Short': 'Long',
      },
      candlestick: {
        'Kæ£’ç‚ºé™°ç·š': 'Kæ£’ç‚ºé™½ç·š', 'Kæ£’ç‚ºé™½ç·š': 'Kæ£’ç‚ºé™°ç·š',
        'é™°ç·š': 'é™½ç·š', 'é™½ç·š': 'é™°ç·š',
        'ç´…K': 'é»‘K', 'é»‘K': 'ç´…K',
      },
      crossover: {
        'ä¸Šç©¿': 'ä¸‹ç©¿', 'ä¸‹ç©¿': 'ä¸Šç©¿',
        'çªç ´': 'è·Œç ´', 'è·Œç ´': 'çªç ´',
        'ç«™ä¸Š': 'è·Œç ´',
        'é‡‘å‰': 'æ­»å‰', 'æ­»å‰': 'é‡‘å‰',
      },
      trend: {
        'ä¸Šæ¼²': 'ä¸‹è·Œ', 'ä¸‹è·Œ': 'ä¸Šæ¼²',
        'ä¸Šå‡': 'ä¸‹é™', 'ä¸‹é™': 'ä¸Šå‡',
        'å¤šæ–¹': 'ç©ºæ–¹', 'ç©ºæ–¹': 'å¤šæ–¹',
      },
      position: {
        'ä¸Šæ–¹': 'ä¸‹æ–¹', 'ä¸‹æ–¹': 'ä¸Šæ–¹',
        'ä¹‹ä¸Š': 'ä¹‹ä¸‹', 'ä¹‹ä¸‹': 'ä¹‹ä¸Š',
        'é«˜æ–¼': 'ä½æ–¼', 'ä½æ–¼': 'é«˜æ–¼',
      }
    };

    const RULE_LABELS = {
      directions: 'æ–¹å‘',
      candlestick: 'Kæ£’',
      crossover: 'ç©¿è¶Š',
      trend: 'è¶¨å‹¢',
      position: 'ä½ç½®'
    };

    // ===== æ•¸æ“šçµæ§‹ =====
    const defaultRow = () => ({ condition: '', param: '', note: '' });
    const defaultExit = () => ({ type: '', condition: '', action: '', next: '' });
    const defaultStage = () => ({ trigger: '', direction: '', defaultSL: '', defaultTP: '', trailingSL: '', trailingTP: '', afterClose: '' });

    const createStrategy = () => ({
      name: '',
      long: {
        stage1: {
          entry: [defaultRow(), defaultRow(), defaultRow(), defaultRow()],
          exit: [
            { type: 'é»˜èªæ­¢æ', condition: '', action: '', next: '' },
            { type: 'ç§»å‹•æ­¢æ', condition: '', action: '', next: '' },
            { type: 'é»˜èªæ­¢ç›ˆ', condition: '', action: '', next: '' },
            { type: 'ç§»å‹•æ­¢ç›ˆ', condition: '', action: '', next: '' }
          ]
        },
        stage2: defaultStage(),
        stage3: defaultStage(),
        stage4: defaultStage()
      },
      short: {
        stage1: {
          entry: [defaultRow(), defaultRow(), defaultRow(), defaultRow()],
          exit: [
            { type: 'é»˜èªæ­¢æ', condition: '', action: '', next: '' },
            { type: 'ç§»å‹•æ­¢æ', condition: '', action: '', next: '' },
            { type: 'é»˜èªæ­¢ç›ˆ', condition: '', action: '', next: '' },
            { type: 'ç§»å‹•æ­¢ç›ˆ', condition: '', action: '', next: '' }
          ]
        },
        stage2: defaultStage(),
        stage3: defaultStage(),
        stage4: defaultStage()
      },
      converted: false
    });

    let strategy = createStrategy();
    let savedList = [];
    let longStage = 1, shortStage = 1;
    let pendingLoadIndex = -1;

    const stageFields = [
      { key: 'trigger', label: 'è§¸ç™¼æ¢ä»¶' },
      { key: 'direction', label: 'é–‹å€‰æ–¹å‘' },
      { key: 'defaultSL', label: 'é»˜èªæ­¢æ' },
      { key: 'defaultTP', label: 'é»˜èªæ­¢ç›ˆ' },
      { key: 'trailingSL', label: 'ç§»å‹•æ­¢æ' },
      { key: 'trailingTP', label: 'ç§»å‹•æ­¢ç›ˆ' },
      { key: 'afterClose', label: 'å¹³å€‰å¾Œ' }
    ];

    // ===== è¼‰å…¥å·²ä¿å­˜åˆ—è¡¨ =====
    function loadSavedList() {
      const raw = localStorage.getItem('_strategyList');
      if (raw) {
        try {
          savedList = JSON.parse(raw);
        } catch {
          savedList = [];
        }
      }
    }

    function saveSavedList() {
      localStorage.setItem('_strategyList', JSON.stringify(savedList));
    }

    // ===== è½‰æ›é‚è¼¯ =====
    function applyConversions(text) {
      if (!text || typeof text !== 'string') return text;
      let r = Security.validate(text);
      
      // å…ˆè™•ç†æ•¸å€¼æ¯”è¼ƒé‹ç®—ç¬¦ï¼ˆ< å’Œ >ï¼‰
      r = r.replace(/<\s*-\s*(\d+)/g, 'Â§GTÂ§ $1');
      r = r.replace(/>\s*(\d+)(?!\s*points)/g, 'Â§LTÂ§ -$1');
      r = r.replace(/CCI\s*>\s*(\d+)/g, 'CCI Â§LTÂ§ -$1');
      r = r.replace(/CCI\s*<\s*-\s*(\d+)/g, 'CCI Â§GTÂ§ $1');
      r = r.replace(/Â§GTÂ§/g, '>').replace(/Â§LTÂ§/g, '<');
      
      // è™•ç†ç‰¹å®šåƒ¹æ ¼æ¯”è¼ƒ
      r = r.replace(/åƒ¹æ ¼\s*>\s*æ…¢ç·š/g, 'åƒ¹æ ¼ Â§LTÂ§ æ…¢ç·š');
      r = r.replace(/åƒ¹æ ¼\s*<\s*æ…¢ç·š/g, 'åƒ¹æ ¼ Â§GTÂ§ æ…¢ç·š');
      r = r.replace(/åƒ¹æ ¼\s*>\s*å¿«ç·š/g, 'åƒ¹æ ¼ Â§LTÂ§ å¿«ç·š');
      r = r.replace(/åƒ¹æ ¼\s*<\s*å¿«ç·š/g, 'åƒ¹æ ¼ Â§GTÂ§ å¿«ç·š');
      r = r.replace(/Close\s*>\s*SMA/g, 'Close Â§LTÂ§ SMA');
      r = r.replace(/Close\s*<\s*SMA/g, 'Close Â§GTÂ§ SMA');
      r = r.replace(/Â§GTÂ§/g, '>').replace(/Â§LTÂ§/g, '<');
      
      // è™•ç† Close > Open å’Œ Close < Openï¼ˆä½¿ç”¨å”¯ä¸€æ¨™è¨˜ï¼‰
      r = r.replace(/Close\s*<\s*Open/gi, 'Â§CLOSELTOPENÂ§');
      r = r.replace(/Close\s*>\s*Open/gi, 'Â§CLOSEGTOPENÂ§');
      
      // æŒ‰é•·åº¦æ’åºæ‰€æœ‰è½‰æ›è¦å‰‡ï¼ˆé•·çš„å„ªå…ˆï¼‰
      const allRules = [];
      for (const cat in CONVERSION_RULES) {
        const rules = CONVERSION_RULES[cat];
        for (const from in rules) {
          allRules.push({ from, to: rules[from], len: from.length });
        }
      }
      allRules.sort((a, b) => b.len - a.len);
      
      // ä½¿ç”¨å”¯ä¸€IDæ¨™è¨˜ï¼Œé¿å…é‡è¤‡è½‰æ›
      let counter = 0;
      const replacements = new Map();
      
      allRules.forEach(rule => {
        // è·³éå·²å–®ç¨è™•ç†çš„ Close < Open å’Œ Close > Open
        if (rule.from === 'Close < Open' || rule.from === 'Close > Open') {
          return;
        }
        
        const regex = new RegExp(rule.from.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        r = r.replace(regex, () => {
          const id = `Â¶ID${counter}Â¶`;
          replacements.set(id, rule.to);
          counter++;
          return id;
        });
      });
      
      // åŸ·è¡Œæ‰€æœ‰æ›¿æ›
      replacements.forEach((value, id) => {
        r = r.replace(new RegExp(id.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), value);
      });
      
      // æ¢å¾© Close å’Œ Open çš„æ¯”è¼ƒ
      r = r.replace(/Â§CLOSELTOPENÂ§/g, 'Close > Open');
      r = r.replace(/Â§CLOSEGTOPENÂ§/g, 'Close < Open');
      
      return r;
    }

    function convertLongToShort() {
      strategy.short.stage1.entry = strategy.long.stage1.entry.map(row => ({
        condition: applyConversions(row.condition),
        param: applyConversions(row.param),
        note: applyConversions(row.note)
      }));
      
      strategy.short.stage1.exit = strategy.long.stage1.exit.map(row => ({
        type: applyConversions(row.type),
        condition: applyConversions(row.condition),
        action: applyConversions(row.action),
        next: applyConversions(row.next)
      }));
      
      [2, 3, 4].forEach(n => {
        stageFields.forEach(({ key }) => {
          strategy.short[`stage${n}`][key] = applyConversions(strategy.long[`stage${n}`][key]);
        });
      });
      
      strategy.converted = true;
      document.getElementById('shortBadge').textContent = 'å·²è½‰æ›';
      document.getElementById('shortBadge').className = 'badge converted';
      
      renderShort();
      updateStats();
      notify('âœ… ç©ºé ­ç­–ç•¥å·²ç”Ÿæˆ', 'info');
    }

    function convertShortToLong() {
      strategy.long.stage1.entry = strategy.short.stage1.entry.map(row => ({
        condition: applyConversions(row.condition),
        param: applyConversions(row.param),
        note: applyConversions(row.note)
      }));
      
      strategy.long.stage1.exit = strategy.short.stage1.exit.map(row => ({
        type: applyConversions(row.type),
        condition: applyConversions(row.condition),
        action: applyConversions(row.action),
        next: applyConversions(row.next)
      }));
      
      [2, 3, 4].forEach(n => {
        stageFields.forEach(({ key }) => {
          strategy.long[`stage${n}`][key] = applyConversions(strategy.short[`stage${n}`][key]);
        });
      });
      
      strategy.converted = true;
      document.getElementById('shortBadge').textContent = 'å·²è½‰æ›';
      document.getElementById('shortBadge').className = 'badge converted';
      
      renderLong();
      updateStats();
      notify('âœ… å¤šé ­ç­–ç•¥å·²ç”Ÿæˆ', 'info');
    }

    function convertStrategy() {
      // æ™ºèƒ½åˆ¤æ–·è½‰æ›æ–¹å‘
      const longHasContent = strategy.long.stage1.entry.some(row => 
        row.condition || row.param || row.note
      );
      const shortHasContent = strategy.short.stage1.entry.some(row => 
        row.condition || row.param || row.note
      );
      
      if (longHasContent && !shortHasContent) {
        // å¤šé ­æœ‰å…§å®¹ï¼Œç©ºé ­æ²’æœ‰ â†’ å¤šè½‰ç©º
        convertLongToShort();
      } else if (shortHasContent && !longHasContent) {
        // ç©ºé ­æœ‰å…§å®¹ï¼Œå¤šé ­æ²’æœ‰ â†’ ç©ºè½‰å¤š
        convertShortToLong();
      } else if (longHasContent && shortHasContent) {
        // å…©é‚Šéƒ½æœ‰å…§å®¹ï¼Œè©¢å•ç”¨æˆ¶
        const choice = confirm('å¤šé ­å’Œç©ºé ­éƒ½æœ‰å…§å®¹ã€‚\n\né»æ“Šã€Œç¢ºå®šã€å°‡å¤šé ­è½‰æ›åˆ°ç©ºé ­\né»æ“Šã€Œå–æ¶ˆã€å°‡ç©ºé ­è½‰æ›åˆ°å¤šé ­');
        if (choice) {
          convertLongToShort();
        } else {
          convertShortToLong();
        }
      } else {
        // å…©é‚Šéƒ½æ²’å…§å®¹
        notify('è«‹å…ˆå¡«å¯«å¤šé ­æˆ–ç©ºé ­ç­–ç•¥å…§å®¹', 'error');
      }
    }

    // ===== UI =====
    function notify(msg, type = 'success') {
      const el = document.getElementById('notification');
      el.textContent = msg;
      el.className = `notification ${type} active`;
      setTimeout(() => el.classList.remove('active'), 2500);
    }

    function esc(s) {
      return Security.escapeHtml(s);
    }

    function renderTabs(id, current, dir) {
      document.getElementById(id).innerHTML = [1, 2, 3, 4].map(n => 
        `<button class="stage-tab ${current === n ? 'active' : ''}" onclick="switchStage('${dir}',${n})">éšæ®µ${n}</button>`
      ).join('');
    }

    function renderLong() {
      renderTabs('longStageTabs', longStage, 'long');
      const c = document.getElementById('longContent');
      
      if (longStage === 1) {
        c.innerHTML = `
          <div class="section-title long">é–‹å€‰æ¢ä»¶</div>
          <div class="data-table">
            <div class="table-header">
              <div class="col-num">#</div>
              <div class="col-flex">æ¢ä»¶</div>
              <div class="col-flex">åƒæ•¸</div>
              <div class="col-flex">èªªæ˜</div>
              <div class="col-action"></div>
            </div>
            ${strategy.long.stage1.entry.map((row, i) => `
              <div class="table-row">
                <div class="col-num">${i + 1}</div>
                <div class="col-flex"><input class="input-field" placeholder="æ¢ä»¶" value="${esc(row.condition)}" onchange="updateLongEntry(${i},'condition',this.value)" maxlength="200"></div>
                <div class="col-flex"><input class="input-field" placeholder="åƒæ•¸" value="${esc(row.param)}" onchange="updateLongEntry(${i},'param',this.value)" maxlength="100"></div>
                <div class="col-flex"><input class="input-field" placeholder="èªªæ˜" value="${esc(row.note)}" onchange="updateLongEntry(${i},'note',this.value)" maxlength="200"></div>
                <div class="col-action"><button class="icon-btn remove" onclick="removeLongEntry(${i})">âœ•</button></div>
              </div>
            `).join('')}
            <div class="add-row"><button class="icon-btn add" onclick="addLongEntry()">+ æ–°å¢</button></div>
          </div>
          
          <div class="section-title long">å¹³å€‰æ¢ä»¶</div>
          <div class="data-table">
            <div class="table-header">
              <div class="col-num">#</div>
              <div class="col-flex">é¡å‹</div>
              <div class="col-flex">æ¢ä»¶</div>
              <div class="col-flex">å‹•ä½œ</div>
              <div class="col-flex">å¾ŒçºŒ</div>
              <div class="col-action"></div>
            </div>
            ${strategy.long.stage1.exit.map((row, i) => `
              <div class="table-row">
                <div class="col-num">${i + 1}</div>
                <div class="col-flex"><input class="input-field" placeholder="é¡å‹" value="${esc(row.type)}" onchange="updateLongExit(${i},'type',this.value)" maxlength="50"></div>
                <div class="col-flex"><input class="input-field" placeholder="æ¢ä»¶" value="${esc(row.condition)}" onchange="updateLongExit(${i},'condition',this.value)" maxlength="200"></div>
                <div class="col-flex"><input class="input-field" placeholder="å‹•ä½œ" value="${esc(row.action)}" onchange="updateLongExit(${i},'action',this.value)" maxlength="200"></div>
                <div class="col-flex"><input class="input-field" placeholder="å¾ŒçºŒ" value="${esc(row.next)}" onchange="updateLongExit(${i},'next',this.value)" maxlength="200"></div>
                <div class="col-action"><button class="icon-btn remove" onclick="removeLongExit(${i})">âœ•</button></div>
              </div>
            `).join('')}
            <div class="add-row"><button class="icon-btn add" onclick="addLongExit()">+ æ–°å¢</button></div>
          </div>
        `;
      } else {
        const data = strategy.long[`stage${longStage}`];
        c.innerHTML = `
          <div class="section-title long">éšæ®µ${longStage} é–‹å€‰æ¢ä»¶</div>
          <div class="data-table">
            <div class="table-header">
              <div class="col-label">é …ç›®</div>
              <div class="col-flex">å…§å®¹</div>
            </div>
            ${stageFields.map(({ key, label }) => `
              <div class="table-row">
                <div class="col-label">${label}</div>
                <div class="col-flex"><input class="input-field" placeholder="${label}" value="${esc(data[key])}" onchange="updateLongStage('${key}',this.value)" maxlength="200"></div>
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    function renderShort() {
      renderTabs('shortStageTabs', shortStage, 'short');
      const c = document.getElementById('shortContent');
      const cv = strategy.converted ? 'converted' : '';
      
      if (shortStage === 1) {
        c.innerHTML = `
          <div class="section-title short">é–‹å€‰æ¢ä»¶</div>
          <div class="data-table">
            <div class="table-header">
              <div class="col-num">#</div>
              <div class="col-flex">æ¢ä»¶</div>
              <div class="col-flex">åƒæ•¸</div>
              <div class="col-flex">èªªæ˜</div>
              <div class="col-action"></div>
            </div>
            ${strategy.short.stage1.entry.map((row, i) => `
              <div class="table-row">
                <div class="col-num">${i + 1}</div>
                <div class="col-flex"><input class="input-field ${cv}" placeholder="æ¢ä»¶" value="${esc(row.condition)}" onchange="updateShortEntry(${i},'condition',this.value)" maxlength="200"></div>
                <div class="col-flex"><input class="input-field ${cv}" placeholder="åƒæ•¸" value="${esc(row.param)}" onchange="updateShortEntry(${i},'param',this.value)" maxlength="100"></div>
                <div class="col-flex"><input class="input-field ${cv}" placeholder="èªªæ˜" value="${esc(row.note)}" onchange="updateShortEntry(${i},'note',this.value)" maxlength="200"></div>
                <div class="col-action"><button class="icon-btn remove" onclick="removeShortEntry(${i})">âœ•</button></div>
              </div>
            `).join('')}
            <div class="add-row"><button class="icon-btn add" onclick="addShortEntry()">+ æ–°å¢</button></div>
          </div>
          
          <div class="section-title short">å¹³å€‰æ¢ä»¶</div>
          <div class="data-table">
            <div class="table-header">
              <div class="col-num">#</div>
              <div class="col-flex">é¡å‹</div>
              <div class="col-flex">æ¢ä»¶</div>
              <div class="col-flex">å‹•ä½œ</div>
              <div class="col-flex">å¾ŒçºŒ</div>
              <div class="col-action"></div>
            </div>
            ${strategy.short.stage1.exit.map((row, i) => `
              <div class="table-row">
                <div class="col-num">${i + 1}</div>
                <div class="col-flex"><input class="input-field ${cv}" placeholder="é¡å‹" value="${esc(row.type)}" onchange="updateShortExit(${i},'type',this.value)" maxlength="50"></div>
                <div class="col-flex"><input class="input-field ${cv}" placeholder="æ¢ä»¶" value="${esc(row.condition)}" onchange="updateShortExit(${i},'condition',this.value)" maxlength="200"></div>
                <div class="col-flex"><input class="input-field ${cv}" placeholder="å‹•ä½œ" value="${esc(row.action)}" onchange="updateShortExit(${i},'action',this.value)" maxlength="200"></div>
                <div class="col-flex"><input class="input-field ${cv}" placeholder="å¾ŒçºŒ" value="${esc(row.next)}" onchange="updateShortExit(${i},'next',this.value)" maxlength="200"></div>
                <div class="col-action"><button class="icon-btn remove" onclick="removeShortExit(${i})">âœ•</button></div>
              </div>
            `).join('')}
            <div class="add-row"><button class="icon-btn add" onclick="addShortExit()">+ æ–°å¢</button></div>
          </div>
        `;
      } else {
        const data = strategy.short[`stage${shortStage}`];
        c.innerHTML = `
          <div class="section-title short">éšæ®µ${shortStage} é–‹å€‰æ¢ä»¶</div>
          <div class="data-table">
            <div class="table-header">
              <div class="col-label">é …ç›®</div>
              <div class="col-flex">å…§å®¹</div>
            </div>
            ${stageFields.map(({ key, label }) => `
              <div class="table-row">
                <div class="col-label">${label}</div>
                <div class="col-flex"><input class="input-field ${cv}" placeholder="${label}" value="${esc(data[key])}" onchange="updateShortStage('${key}',this.value)" maxlength="200"></div>
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    function updateStats() {
      document.getElementById('savedCount').textContent = savedList.length;
      document.getElementById('longEntryCount').textContent = strategy.long.stage1.entry.length;
      document.getElementById('shortEntryCount').textContent = strategy.short.stage1.entry.length;
    }

    function switchStage(dir, n) {
      // å¤šç©ºéšæ®µåŒæ­¥é€£å‹•
      longStage = n;
      shortStage = n;
      renderLong();
      renderShort();
    }

    // Data update functions with validation
    function updateLongEntry(i, field, value) {
      strategy.long.stage1.entry[i][field] = Security.validate(value);
    }
    function updateLongExit(i, field, value) {
      strategy.long.stage1.exit[i][field] = Security.validate(value);
    }
    function updateLongStage(field, value) {
      strategy.long[`stage${longStage}`][field] = Security.validate(value);
    }
    function updateShortEntry(i, field, value) {
      strategy.short.stage1.entry[i][field] = Security.validate(value);
    }
    function updateShortExit(i, field, value) {
      strategy.short.stage1.exit[i][field] = Security.validate(value);
    }
    function updateShortStage(field, value) {
      strategy.short[`stage${shortStage}`][field] = Security.validate(value);
    }

    function addLongEntry() {
      if (strategy.long.stage1.entry.length >= 20) {
        notify('æœ€å¤š 20 å€‹æ¢ä»¶', 'error');
        return;
      }
      strategy.long.stage1.entry.push(defaultRow());
      renderLong();
      updateStats();
    }
    function removeLongEntry(i) {
      if (strategy.long.stage1.entry.length > 1) {
        strategy.long.stage1.entry.splice(i, 1);
        renderLong();
        updateStats();
      }
    }
    function addLongExit() {
      if (strategy.long.stage1.exit.length >= 20) {
        notify('æœ€å¤š 20 å€‹å¹³å€‰æ¢ä»¶', 'error');
        return;
      }
      strategy.long.stage1.exit.push(defaultExit());
      renderLong();
    }
    function removeLongExit(i) {
      if (strategy.long.stage1.exit.length > 1) {
        strategy.long.stage1.exit.splice(i, 1);
        renderLong();
      }
    }
    function addShortEntry() {
      if (strategy.short.stage1.entry.length >= 20) {
        notify('æœ€å¤š 20 å€‹æ¢ä»¶', 'error');
        return;
      }
      strategy.short.stage1.entry.push(defaultRow());
      renderShort();
      updateStats();
    }
    function removeShortEntry(i) {
      if (strategy.short.stage1.entry.length > 1) {
        strategy.short.stage1.entry.splice(i, 1);
        renderShort();
        updateStats();
      }
    }
    function addShortExit() {
      if (strategy.short.stage1.exit.length >= 20) {
        notify('æœ€å¤š 20 å€‹å¹³å€‰æ¢ä»¶', 'error');
        return;
      }
      strategy.short.stage1.exit.push(defaultExit());
      renderShort();
    }
    function removeShortExit(i) {
      if (strategy.short.stage1.exit.length > 1) {
        strategy.short.stage1.exit.splice(i, 1);
        renderShort();
      }
    }

    // Strategy name
    document.getElementById('strategyName').addEventListener('input', function() {
      strategy.name = Security.validate(this.value, 100);
    });

    // Password toggle
    document.getElementById('usePassword').addEventListener('change', function() {
      document.getElementById('strategyPasswordGroup').style.display = this.checked ? 'block' : 'none';
    });

    // New
    function newStrategy() {
      strategy = createStrategy();
      document.getElementById('strategyName').value = '';
      document.getElementById('shortBadge').textContent = 'ç­‰å¾…è½‰æ›';
      document.getElementById('shortBadge').className = 'badge';
      longStage = shortStage = 1;
      renderLong();
      renderShort();
      updateStats();
      notify('å·²å‰µå»ºæ–°ç­–ç•¥');
    }

    // Save
    function showSaveModal() {
      document.getElementById('saveStrategyName').value = strategy.name;
      document.getElementById('usePassword').checked = false;
      document.getElementById('strategyPasswordGroup').style.display = 'none';
      document.getElementById('strategyPassword').value = '';
      document.getElementById('saveModal').classList.add('active');
    }
    function closeSaveModal() {
      document.getElementById('saveModal').classList.remove('active');
    }

    function saveStrategy() {
      let name = Security.validate(document.getElementById('saveStrategyName').value.trim(), 100);
      
      // å¦‚æœæ²’æœ‰è¼¸å…¥åç¨±ï¼Œè‡ªå‹•ç”Ÿæˆ
      if (!name) {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
        const count = savedList.length + 1;
        name = `ç­–ç•¥_${count}_${timestamp}`;
      }
      
      const usePassword = document.getElementById('usePassword').checked;
      const password = usePassword ? document.getElementById('strategyPassword').value : '';
      
      strategy.name = name;
      document.getElementById('strategyName').value = name;
      
      const storageKey = 'strategy_' + Crypto.hash(name);
      
      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåç­–ç•¥
      const idx = savedList.findIndex(s => s.name === name);
      
      const meta = {
        name,
        savedAt: new Date().toISOString(),
        hasPassword: usePassword,
        key: storageKey
      };
      
      if (idx >= 0) {
        // åŒåç­–ç•¥ï¼Œè©¢å•æ˜¯å¦è¦†è“‹
        if (!confirm(`å·²å­˜åœ¨åç‚ºã€Œ${name}ã€çš„ç­–ç•¥ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ`)) {
          return;
        }
        savedList[idx] = meta;
        notify('âœ… ç­–ç•¥å·²æ›´æ–°', 'success');
      } else {
        // æ–°ç­–ç•¥ï¼Œç›´æ¥æ·»åŠ 
        savedList.push(meta);
        notify('âœ… ç­–ç•¥å·²ä¿å­˜', 'success');
      }
      
      SecureStorage.save(storageKey, strategy, password);
      saveSavedList();
      
      closeSaveModal();
      updateStats();
      notify('ğŸ” å·²åŠ å¯†ä¿å­˜');
    }

    // Load
    function showLoadModal() {
      const list = document.getElementById('savedList');
      if (savedList.length === 0) {
        list.innerHTML = '<div class="empty-state">å°šç„¡ä¿å­˜çš„ç­–ç•¥</div>';
      } else {
        list.innerHTML = savedList.map((s, i) => `
          <div class="saved-item">
            <div class="info">
              <div class="name">${esc(s.name)} ${s.hasPassword ? 'ğŸ”' : ''}</div>
              <div class="date">${s.savedAt ? new Date(s.savedAt).toLocaleString() : ''}</div>
              ${s.hasPassword ? '<div class="encrypted">å¯†ç¢¼ä¿è­·</div>' : ''}
            </div>
            <div class="actions">
              <button class="btn btn-primary" onclick="loadStrategy(${i})">è¼‰å…¥</button>
              <button class="btn btn-danger" onclick="deleteStrategy(${i})">åˆªé™¤</button>
            </div>
          </div>
        `).join('');
      }
      document.getElementById('loadModal').classList.add('active');
    }
    function closeLoadModal() {
      document.getElementById('loadModal').classList.remove('active');
    }

    function loadStrategy(i) {
      const meta = savedList[i];
      const result = SecureStorage.load(meta.key);
      
      if (!result) {
        notify('è¼‰å…¥å¤±æ•—', 'error');
        return;
      }
      
      if (result.needPassword) {
        pendingLoadIndex = i;
        document.getElementById('loadPassword').value = '';
        document.getElementById('passwordModal').classList.add('active');
        return;
      }
      
      strategy = result;
      document.getElementById('strategyName').value = strategy.name;
      document.getElementById('shortBadge').textContent = strategy.converted ? 'å·²è½‰æ›' : 'ç­‰å¾…è½‰æ›';
      document.getElementById('shortBadge').className = strategy.converted ? 'badge converted' : 'badge';
      
      closeLoadModal();
      longStage = shortStage = 1;
      renderLong();
      renderShort();
      updateStats();
      notify('å·²è¼‰å…¥');
    }

    function confirmLoadWithPassword() {
      const password = document.getElementById('loadPassword').value;
      const meta = savedList[pendingLoadIndex];
      const result = SecureStorage.load(meta.key, password);
      
      if (!result || result.wrongPassword) {
        notify('å¯†ç¢¼éŒ¯èª¤', 'error');
        return;
      }
      
      strategy = result;
      document.getElementById('strategyName').value = strategy.name;
      document.getElementById('shortBadge').textContent = strategy.converted ? 'å·²è½‰æ›' : 'ç­‰å¾…è½‰æ›';
      document.getElementById('shortBadge').className = strategy.converted ? 'badge converted' : 'badge';
      
      closePasswordModal();
      closeLoadModal();
      longStage = shortStage = 1;
      renderLong();
      renderShort();
      updateStats();
      notify('å·²è¼‰å…¥');
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').classList.remove('active');
      pendingLoadIndex = -1;
    }

    function deleteStrategy(i) {
      const meta = savedList[i];
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç­–ç•¥ã€Œ${meta.name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
        return;
      }
      SecureStorage.remove(meta.key);
      savedList.splice(i, 1);
      saveSavedList();
      showLoadModal();
      updateStats();
      notify('âœ… å·²åˆªé™¤', 'success');
    }

    // Security Modal
    function showSecurityModal() {
      document.getElementById('masterPassword').value = '';
      document.getElementById('securityModal').classList.add('active');
    }
    function closeSecurityModal() {
      document.getElementById('securityModal').classList.remove('active');
    }

    function setMasterPassword() {
      const pwd = document.getElementById('masterPassword').value;
      SecureStorage.setMasterPassword(pwd);
      notify(pwd ? 'ä¸»å¯†ç¢¼å·²è¨­å®š' : 'å·²ä½¿ç”¨é è¨­å¯†é‘°', 'info');
      closeSecurityModal();
    }

    function clearAllData() {
      if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        SecureStorage.clear();
        savedList = [];
        strategy = createStrategy();
        document.getElementById('strategyName').value = '';
        renderLong();
        renderShort();
        updateStats();
        notify('æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤', 'info');
        closeSecurityModal();
      }
    }

    function exportBackup() {
      const backup = {
        version: 2,
        exportedAt: new Date().toISOString(),
        list: savedList,
        data: {}
      };
      
      savedList.forEach(meta => {
        const raw = localStorage.getItem(meta.key);
        if (raw) {
          backup.data[meta.key] = raw;
        }
      });
      
      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ç­–ç•¥å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      notify('å‚™ä»½å·²åŒ¯å‡º');
    }

    function importBackup(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const backup = JSON.parse(e.target.result);
          
          if (!backup.version || !backup.list) {
            throw new Error('ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆ');
          }
          
          // åŒ¯å…¥æ•¸æ“š
          for (const key in backup.data) {
            localStorage.setItem(key, backup.data[key]);
          }
          
          // åˆä½µåˆ—è¡¨
          backup.list.forEach(meta => {
            if (!savedList.find(s => s.name === meta.name)) {
              savedList.push(meta);
            }
          });
          
          saveSavedList();
          updateStats();
          notify('å‚™ä»½å·²åŒ¯å…¥');
          
        } catch (err) {
          notify('åŒ¯å…¥å¤±æ•—: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Rules
    function showRulesModal() {
      let html = '<div style="margin-bottom: 16px; padding: 12px; background: rgba(0,212,255,0.1); border-radius: 8px; font-size: 13px; line-height: 1.6;">';
      html += '<strong style="color: #00d4ff;">âœ¨ æ™ºèƒ½é›™å‘è½‰æ›</strong><br>';
      html += 'â€¢ å¡«å¯«å¤šé ­ â†’ è‡ªå‹•ç”Ÿæˆç©ºé ­<br>';
      html += 'â€¢ å¡«å¯«ç©ºé ­ â†’ è‡ªå‹•ç”Ÿæˆå¤šé ­<br>';
      html += 'â€¢ å…©é‚Šéƒ½æœ‰ â†’ è©¢å•è½‰æ›æ–¹å‘<br>';
      html += '</div>';
      
      for (const cat in CONVERSION_RULES) {
        html += `<div class="rule-category"><h5>${RULE_LABELS[cat]}</h5>`;
        for (const [from, to] of Object.entries(CONVERSION_RULES[cat])) {
          html += `<div class="rule-item"><span class="from">${esc(from)}</span><span class="arrow">â‡„</span><span class="to">${esc(to)}</span></div>`;
        }
        html += '</div>';
      }
      document.getElementById('rulesContent').innerHTML = html;
      document.getElementById('rulesModal').classList.add('active');
    }
    function closeRulesModal() {
      document.getElementById('rulesModal').classList.remove('active');
    }

    // Excel Export
    function exportToExcel() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([]);
      
      const titleStyle = { font: { bold: true, sz: 14, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '4472C4' } }, border: getBorder() };
      const headerStyle = { font: { bold: true, sz: 11 }, fill: { fgColor: { rgb: 'B4C6E7' } }, border: getBorder() };
      const cellStyle = { border: getBorder() };
      
      function getBorder() {
        return {
          top: { style: 'thin', color: { rgb: '000000' } },
          bottom: { style: 'thin', color: { rgb: '000000' } },
          left: { style: 'thin', color: { rgb: '000000' } },
          right: { style: 'thin', color: { rgb: '000000' } }
        };
      }
      
      let row = 0;
      
      addMergedCell(ws, row, 0, `<<${strategy.name || 'æœªå‘½å'}>>`, titleStyle, 4);
      row += 2;
      
      row = addDirectionSection(ws, row, 'long', 'å¤šé ­');
      row += 1;
      row = addDirectionSection(ws, row, 'short', 'ç©ºé ­');
      
      function addMergedCell(ws, r, c, value, style, colspan) {
        const cell = { v: Security.validate(value), t: 's', s: style };
        const addr = XLSX.utils.encode_cell({ r, c });
        ws[addr] = cell;
        if (colspan > 1) {
          if (!ws['!merges']) ws['!merges'] = [];
          ws['!merges'].push({ s: { r, c }, e: { r, c: c + colspan - 1 } });
        }
      }
      
      function addRow(ws, r, values, style) {
        values.forEach((v, c) => {
          const addr = XLSX.utils.encode_cell({ r, c });
          ws[addr] = { v: Security.validate(v || ''), t: 's', s: style };
        });
      }
      
      function addDirectionSection(ws, startRow, dir, label) {
        let r = startRow;
        const data = strategy[dir];
        
        addMergedCell(ws, r, 0, `ã€éšæ®µ1 ${label}é–‹å€‰æ¢ä»¶ã€‘`, titleStyle, 4);
        r++;
        addRow(ws, r, ['åºè™Ÿ', 'æ¢ä»¶', 'åƒæ•¸', 'èªªæ˜'], headerStyle);
        r++;
        data.stage1.entry.forEach((entry, i) => {
          addRow(ws, r, [i + 1, entry.condition, entry.param, entry.note], cellStyle);
          r++;
        });
        r++;
        
        addMergedCell(ws, r, 0, `éšæ®µ1 ${label}å¹³å€‰æ¢ä»¶`, titleStyle, 4);
        r++;
        addRow(ws, r, ['é¡å‹', 'æ¢ä»¶', 'å‹•ä½œ', 'å¾ŒçºŒ'], headerStyle);
        r++;
        data.stage1.exit.forEach((exit) => {
          addRow(ws, r, [exit.type, exit.condition, exit.action, exit.next], cellStyle);
          r++;
        });
        r++;
        
        [2, 3, 4].forEach(n => {
          const stageData = data[`stage${n}`];
          addMergedCell(ws, r, 0, `éšæ®µ${n} ${label}é–‹å€‰æ¢ä»¶`, titleStyle, 2);
          r++;
          addRow(ws, r, ['é …ç›®', 'æ¢ä»¶/å…§å®¹'], headerStyle);
          r++;
          stageFields.forEach(({ key, label: lbl }) => {
            addRow(ws, r, [lbl, stageData[key]], cellStyle);
            r++;
          });
          r++;
        });
        
        return r;
      }
      
      ws['!cols'] = [{ wch: 15 }, { wch: 35 }, { wch: 20 }, { wch: 20 }];
      
      const lastRow = row;
      ws['!ref'] = XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: lastRow, c: 3 } });
      
      XLSX.utils.book_append_sheet(wb, ws, 'äº¤æ˜“ç­–ç•¥');
      XLSX.writeFile(wb, `${Security.validate(strategy.name || 'ç­–ç•¥')}_${new Date().toISOString().slice(0,10)}.xlsx`);
      notify('å·²åŒ¯å‡º Excel');
    }

    // Init
    loadSavedList();
    renderLong();
    renderShort();
    updateStats();
    checkInstallNotice();
    
    // æª¢æŸ¥æ˜¯å¦é¡¯ç¤ºå®‰è£æç¤º
    function checkInstallNotice() {
      // åªåœ¨æ‰‹æ©Ÿä¸Šé¡¯ç¤ºï¼Œä¸”æœªè¢«é—œé–‰é
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const isDismissed = localStorage.getItem('_installDismissed');
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      
      if (isMobile && !isDismissed && !isStandalone) {
        document.getElementById('installNotice').style.display = 'flex';
      }
    }
    
    function dismissInstallNotice() {
      document.getElementById('installNotice').style.display = 'none';
      localStorage.setItem('_installDismissed', 'true');
    }
    
    function showInstallGuide() {
      document.getElementById('installModal').classList.add('active');
    }
    
    function closeInstallModal() {
      document.getElementById('installModal').classList.remove('active');
    }
  </script>
</body>
</html>
